---
title: "Tutorial"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Tutorial}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(rmarkdown.html_vignette.check_title = FALSE)
```

## Overview

In this vignette, we provide a detailed tutorial of the key functionalities of the `RaCE.NMA` R package. The package has functions to complete three primary tasks when utilizing the proposed RaCE methodology for network meta-analysis:

1. Model estimation
2. Model assessment
3. Inference and summary statistics

We demonstrate each of these tasks below, after loading the necessary packages.

```{r warning=FALSE,message=FALSE}
library(RaCE.NMA)
library(reshape2) # data reformatting
library(ggplot2)  # creating nice figures
```

## Data

Throughout this tutorial, we use a dataset displaying the results of a previous NMA study provided by Wang et. al (2022). The data is loaded below:

```{r}
data("wang_posterior") # loads posterior of non-baseline treatments

# define assumed mean and variance for baseline treatment (R-CHOP)
ybar_baseline <- 0
var_baseline <- min(apply(wang_posterior,2,var))/10

# calculate summary statistics, ybar, cov, and s for all treatments
wang_ybar <- c( ybar_baseline, apply(wang_posterior,2,mean) )
wang_cov <- cbind( c(var_baseline, rep(0, 10) ),
              rbind(0, cov(wang_posterior)) )
wang_s <- sqrt(diag(wang_cov))

# store treatment names
treatments <- c("R-CHOP", names(wang_posterior))
```

The following forest plot displays the relative treatment effects of the 11 treatments in the study, as estimated by Wang et. al (2022).

```{r fig.asp=0.5}
create_forestplot(wang_posterior,names=treatments[-1])
```

## 1. Model Estimation

The `RaCE.NMA` packages contains a primary model-fitting function, `mcmc_RCMVN`. The function requires many inputs, which may be broken down into three categories:

  + Previous results from an NMA analysis: The user must provide results on the relative treatment effects from a previous NMA study. Various formats are allowed; see below.
  + Model hyperparameters: Parameters which correspond to "priors" in the Bayesian model. Vague priors are available by default.
  + MCMC settings: Specifications of an MCMC estimation procedure, including the number of independent chains, length of each chain, thinning and burn-in, etc. By default, the function runs 2 chains, each of length 15000 and removes the first half of iterations as burn-in.
  
### Previous results from an NMA analysis

If available, we recommend inputting the full posterior of the relative treatment effect from a previous NMA analysis into the `mcmc_RCMVN` function. In this case, the `posterior` argument should be provided an $N\times J$ matrix, where the (i,j) entry indicates the relative treatment effect of treatment $j$ in MCMC draw $i$. An example of this functionality is provided below:

```{r eval=F}
mcmc_RCMVN(posterior = wang_posterior)
```

In the above code, default settings are used for all other inputs. (We recommend against this practice.)

Alternatively, one may provide summary statistics of the model posterior (instead of a full posterior itself). This is useful when applying the RaCE-NMA methodology to the results of a published paper post-hoc, when only summary statistics are available. In this setting, the user must provide two inputs:

  + `ybar`: A vector of length $J$ (the number of treatments), where the $j$th entry displays the average relative treatment effect of treatment $j$
  + `cov` or `s`: A $J\times J$ matrix or vector of length $J$, which contain either a covariance matrix of the relative treatment effects or the treatment-specific standard deviations of relative treatment effects.
  
If `posterior` is provided, any inputs for `ybar`, `cov`, and `s` will be ignored. If `cov` is provided, `s` is ignored. An example of this functionality is provided below:

```{r eval=F}
mcmc_RCMVN(ybar = wang_ybar, cov = wang_cov) # cov example
mcmc_RCMVN(ybar = wang_ybar, s = wang_s) # s example
```

### Model hyperparameters

Next, we may specify the following hyperparameters:

  + `mu0`: The prior mean on the rank-clustered relative treatment effects. Defaults to `mean(ybar)`, which aims to be vague.
  + `sigma0`: The prior standard deviation on the rank-clustered relative treatment effects. Defaults to `sqrt(10*var(ybar))`, which aims to be vague.
  
The following code demonstrates how one could specify these hyperparameters directly in the estimation function:

```{r eval=F}
mcmc_RCMVN(posterior = wang_posterior, 
           mu0 = mean(wang_ybar), sigma0 = sqrt(10*var(wang_ybar)) )
```

### MCMC settings

Last, we may specify parameters that control how the MCMC chains are run:

  + `tau`: The standard deviation of the Metropolis Hastings proposal distribution. Defaults to `min(|ybar_i-ybar_j|)`. 
  + `nu0`: How cluster-specific mean parameters are initialized. Defaults to `NULL`, which randomly samples from the prior distribution.
  + `num_iters`: The number of times the rank-clustering structure is sampled in each MCMC chain. Defaults to $5{,}000$.
  + `nu_reps`: The number of times each cluster-specific mean is sampled per sampling of the rank-clustering structure. Defalts to $3$. In total, there will be `num_iters`$\times$`nu_reps` samples from the posterior.
  + `chains`: The number of independent MCMC chains. Defaults to 2.
  + `burn_prop`: The proportion of MCMC samples in each chain to be removed as burn-in. Defaults to 0.5.
  + `thin`: A number indicating how often to thin samples. Defaults to 1, indicating no thinning.
  + `seed`: The random seed to run chains. Defaults to `NULL`, meaning the environment seed is inherited.

The following code demonstrates how one could specify some of these settings directly in the estimation function:

```{r }
mcmc_results <- mcmc_RCMVN(
  ybar = wang_ybar, cov = wang_cov,
  mu0 = mean(wang_ybar), sigma0 = sqrt(10*var(wang_ybar)),
  num_iters = 500, nu_reps = 2, chains = 2, seed = 1  #FIX:10000
)
```

## 2. Model Assessment

The package contains three functions to assess if the MCMC chains have converged and mixed. The first two produce trace plots of `mu` and `K`, the primary model parameters. The third calculates the $\hat{R}$ statistic for each `mu` parameter. A standard rule of thumb is to ensure that $\hat{R}<1.1$.

```{r}
createtrace_mu(mcmc_results, names=treatments)
createtrace_K(mcmc_results)
calculate_Rhat(mcmc_results, names=treatments)
```

## 3. Inference and summary statistics

Often, we are most interested in creating a clustering probability matrix and a cumulative ranking curve. We create these plots and tables in the code chunks below.

```{r fig.asp=0.6}
create_clustermatrix(mcmc=mcmc_results, names = treatments, label_ranks = 1)
```
```{r fig.asp=0.4}
create_cumulativeranking(mcmc=mcmc_results, names=treatments)
```
```{r}
calculate_SUCRA_MNBT(mcmc=mcmc_results,names=treatments)
```
